---
title: "Step-by-step"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Step-by-step}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r options, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, echo=FALSE}
library(stringr)

```

### Files

Three, with an optional fourth type of files are needed for execution of the MBBE package. These are:

1.  Model files. Standard NONMEM control files, one or more describing one or more candidate models to be averaged.

2.  Data file(s) - one or two. A analysis data set for the NONMEM model estimation in the bootstrap is required. In addition data file for simulation of the intended virtual BE study is required. These may be the same file.

3.  The MBBE specification file. A json format file describing the analysis.

4.  (Optional) User supplied R code that returns a value that can be added to the default model selection criteria (BIC) used for model averaging. Must be called "RPenaltyCode.R".

## First you need model(s)

Five models are provided with the MBBE package. Any number of model \> 1 can be used, bearing mind that the total number of bootstrap samples will be the number of models x the sample size. These models were selected using [pyDarwin](https://certara.github.io/pyDarwin/html/index.html). Example models (model1.mod - model5.mod) are at:

```{r include=FALSE}
models_path <- file.path(system.file(package = "mbbe"),"inst","examples")
if( .Platform$OS.type == "windows" )
  models_path <- str_replace_all(models_path,"//","\\")
```

```{r}
cat(models_path)
```

These model need not have a \$COV record (unless that is needed for any user defined R code). There are few restriction on the structure of the model. However, there are a significant number of requirement for both the control file and data file format. It is recommended that the full path to the data set be provided in the \$DATA record.

There are four critical requirements of the model files format. There are:

1.  The values

-   GROUP

-   PERIOD

-   SEQ

2.  Only THETAs may be estimated. To accomplish this, \$OMEGA and \$SIGMA block can be FIXed to 1 and ETAs and EPSs multiplied by a THETA, see examples at

```{r include=FALSE}
models_path <- file.path(system.file(package = "mbbe"),"inst","examples")
if( .Platform$OS.type == "windows" )
  models_path <- str_replace_all(models_path,"//","\\")
```

```{r}
cat(models_path)
```

3.  The \$ESTIMATION record, followed by the \$THETA block MUST be the final two blocks in the control file (with the exception of any \$TABLE records that might be needed for any user supplied R code).

4.  The line

\|;;;; Start EST.

must appear immediately before the \$EST record.The reason for these two requirements is that the simulation control files are constructed from the analysis control files. All content in the analysis control file is copied, then everything after the line

\|;;;; Start EST

is removed and replace with a \$SIM record, followed by the theta estimates extracted from the .xml file for that model and bootstrap sample. A \$TABLE record is then added, with data items required for the power calculation. Note that this \$TABLE record appended to the simulation control file will include:

-   GROUP

-   PERIOD

-   SEQ

and so these data must be available, either in the data set or calculated in the analysis control file. In addition the \$DATA record is editted to reference the simulation data set, rather than the anaysis data Note that the \$\$INPUT record is preserved between the analysis control file and the generated simulation control file, and so the structure of the analysis and simulation data sets must be the same.

If identifiability check is requested, then the option "SADDLE_RESET=1" must be included in the \$ESTIMATION record.

## Next you need two data sets (although they can be the same one)

Two formatted data set are provide here:

```{r include=FALSE}
data_path <- file.path(system.file(package = "mbbe"),"inst","examples","data.csv")
data_sim_path <- file.path(system.file(package = "mbbe"),"inst","examples","data_sim.csv")
if( .Platform$OS.type == "windows" )
  data_path <- str_replace_all(data_path,"//","\\")
if( .Platform$OS.type == "windows" )
  data_sim_path <- str_replace_all(data_sim_path,"//","\\")
```

```{r}
cat(data_path)
cat(data_sim_path)
```

Note that, in this case, these two data sets are identical. In general, the analysis data set, for bootstrap, will not be the same as the simulation data. For example, it may be the case that only sparse data may be available for analysis (e.g., clinical scenarios were few samples can be collected), or a cross over study may not be feasible (e.g., long acting injectables). Still the simulation must be done using a traditional study design, e.g., 4 period, cross over study. The typical scenario is to use a different study design that the study(ies) that generated the observed data, assuming that if the observed data were from an adequate BE study, those data would be used to assess BE.

The analysis data set is specified on the \$DATA record in the NONMEM control files for the bootstrap. The simulation data set is specified as in the MBBE specification file:

```{r include=FALSE}
MBBE_file <- file.path(system.file(package = "mbbe"),"inst","examples","mbbeargs.json") 
if( .Platform$OS.type == "windows" )
  MBBE_file <- str_replace_all(MBBE_file,"//","\\")
```

```{r}
cat(MBBE_file) 
```

Several notes on the data:

1.  Data item for "GROUP" (1,2 are reference, 3,4 are test in the examples) is included both in the analysis data set and the simulation data set. The example simulation data set (data_sim.csv) and the source data set (data.csv) are both 4 period cross over studies, and so there are 4 values for group (although only 2 formulations). It is not a requirement that the source data be a typical 4 period cross over study, although data for both test and reference formulation need to be included in order to estimate any formulation effects.

2.  Data item for "PERIOD" is provided (1-4). In general, between occasion variability (e.g., by study period) should be assessed and included in the model(s) is supported. The PERIOD data item is required in both the source and simulation data sets.

3.  Data item for sequence ("SEQ") is provided (1-2). Presumable period and sequence were tested in the model selection and not found to be supported. However, they are required for the Monte Carlo simulation and statistical testing.

## User supplied penalty R code

The model averaging is, by default, based on the Bayesian Information criteria (BIC), with the option to preclude any results that fail the [Identifiability test](https://www.page-meeting.org/pdf_assets/1345-PAGE_2017_SADDLE_RESET_Final.pdf). Another, more general option is to include a user defined R function, to return a penalty that is added to the BIC. The path to the file containing this function can be specified in the R_code_path option in the json file, and the user_R\_code option set to "true". The function must be called MBBE_RPenaltyCode, and take the arguments:

-   run_dir - the parent run directory, as specified in the json file

-   this_model - the model number

-   this_samp - ths bootstrap sample number.

These arguments can then be used to access any output from the NONMEM bootstrap model, such the .lst file, the .xml file. The file structure will be

run_dir/modelM/N

Where run_dir is the run directory (run_dir) specified in the MBBEjson file, M is the model number and N is the bootstrap sample number. The output (.lst) and xml (.xml) files will be called:

bsSampM_N.lst

and bsSampM_N.xml

respectively.

Where M is the model number and N is the bootstrap sample number. Any \$TABLE file, including \$SIM output, that is specified in the analysis control files can be accesses as well, using the file structure information described above.

The function should return, in all case, a numeric penalty. An example R to return a penalty for bias in simulated Cmax is given in RPenaltyCode.R. This function requires that a 2nd problem (for simulation) be included in the control files. An example where RPenaltyCode.R returns a penalty for bias in prediction of Cmax is given in:

```{r include=FALSE}
Rcode_path <- file.path(system.file(package = "mbbe"),"inst","RPenaltyCode.R")
if( .Platform$OS.type == "windows" )
  Rcode_path <- str_replace_all(Rcode_path,"//","\\")
```

```{r}
cat(Rcode_path)
```

### The MBBE Specification file

An example MBBE specification file is given at:

```{r include=FALSE}
MBBE_file <- file.path(system.file(package = "mbbe"),"inst","examples","mbbeargs.json")
if( .Platform$OS.type == "windows" )
  MBBE_file <- str_replace_all(MBBE_file,"//","\\")

```

```{r}
cat(MBBE_file)
```

The json file consists of key-value pairs. All pairs are required, except "R_code_path": is not required if "user_R\_code": if set to false.

The key-value pairs are:

##### "run_dir":

(string) parent directory where NONMEM is to be run. The bootstrap runs will be execucted in run_dir/modelM/N

Where M is the model number and N is the bootstrap sample number. The output (.lst) and xml (.xml) files will be bsSampM_N.lst and bsSampM_N.xml

##### "model_source":

(list) A list of paths to the candidate models. Json syntax for list is: ["path1", "path2, ...]. Note that separator in path will be forward slash "/".

##### "num_parallel":

(integer) Number of NONMEM executions to be run in parallel. In general should not exceed the number cores

##### "crash_value":

(numeric) A value to be assigned to the model selection criteria if the calculation fails. Should be larger than any anticipated value for BIC + any R penalty.

##### "nmfe_path":

(string) Path to nmfe??.bat. Note that separator in path will be forward slash "/".

##### "delta_parms":

(numeric) Largest fractional difference between any parameters before and after the SADDLE_RESET that is permitted. Any model/sample with a value larger than delta_parm will result in a failed idenfiability test for that model/sample and will be be selected for the model averaging. If all models for a given sample fail the identifiability test, that sample is excluded from the Monte Carlo simulation.

##### "use_check_identifiable":

(logical) true or false, if identifability is to be checked.

##### "NCA_end_time":

(numeric) End time for calculation of AUC

##### "rndseed":

(integer) Random seed for Bootstrap sampling and Monte Carlo Simulation

##### "simulation_data_path":

(string) Path to simulation data set. Note that separator in path will be forward slash "/".

##### "ngroups":

(integer) Number of GROUPs.

##### "samp_size":

(integer) Number of bootstrap and Monte Carlo Simulations

##### "reference_groups":

(list of integers) Which of the GROUPS are reference formulation

##### "test_groups":

(list of integers) Which of the GROUPS are test formulation

\##### "plan":

(string)- strategy for running R parallel. [Options are](https://rdrr.io/cran/future/man/plan.html):

sequential: Resolves futures sequentially in the current R process, e.g. plan(sequential).

multisession: Resolves futures asynchronously (in parallel) in separate R sessions running in the background on the same machine, e.g. plan(multisession) and plan(multisession, workers = 2).

multicore: Resolves futures asynchronously (in parallel) in separate forked R processes running in the background on the same machine, e.g. plan(multicore) and plan(multicore, workers = 2). This backend is not supported on Windows.

##### "alpha_error":

(numeric)- alpha error for computing one sided T tests

##### "NTID":

(logical) true or false, whether this is a narrow therapeutic index drug.

##### "model_averaging_by":

(string) "study" \| "subject". "study" is recommended, "subject" is experimental

##### "user_R\_code":

(logical) true of false, if user supplied R code is to be run and included in model averaging penalty. If true, R_code_path is required.

##### "R_code_path":

(string) - path to user supplied R code for calculating additional penalty for model averaging.

### Execution

MBBE is executed from the command line with

*mbbe::run_mbbe_json("path")*

where *"path*" is the path to the MBBE specification file.

## Output

## Console output

The start date and time of each event in the MBBE process will be listed. The initial output from MBBE describes the options for running MBBE and results of checks.

When the bootstrap starts, MBBE will print out a progress line that describes what percent of the bootstrap models have been started. Completion of the bootstrap step will occur after all the models are started, and them completed.

Various status update message will be displayed as the bootstrap is completed, model parameters are collected, if requested, user supplied R code penalty etc.

Once the BIC and total penalty values are calculated, they will be displayed.

When available, the estimated power for Cmax, AUC~last~ and AUC~infinity~ will be displayed and the number of bootstrap sample for each model that are identifable is output.

Finally, the statistical output includes, for each Monte Carlo simulation, whether the parameters (Cmax, AUC~last~ and AUC~infinity~) are bioequivalence, the ratio for each and the upper and lower limits of the confidence interval for the ratio.

### File output

A comma seprated file with BIC values will be written to

run_dir/BICS.csv and total penalties written to

run_dir/Total_penalties.csv

where run_dir is the run directory specified in the MBBE specification file.

The power for each parameter is written out to the file

run_dir/MBBEpower[data-time].csv

where [data-time] is the analysis completion date and time.

All statistical results are written to run_dir/All_results.csv.
